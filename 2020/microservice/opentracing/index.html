<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"haoyunlaile.github.io","root":"/","scheme":"Pisces","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Comment","order":-1}},"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="概念当我们把系统微服务化后，想查询某个接口一次请求的耗时信息，需要登录多台机器查询相关日志才行。 如下图所示架构，当对应服务集群化部署后，想要查询到某一次请求信息更是难上加难。那我们有什么办法可以解决这个问题么？ 答案当然是有的，分布式追踪系统正是为了解决这个问题而生。分布式跟踪为描述和分析跨进程事务提供了一种解决方案。如Google Dapper论文 (业界的分布式追踪系统基本都是以这篇论文为基">
<meta property="og:type" content="article">
<meta property="og:title" content="分布式跟踪系统">
<meta property="og:url" content="http://haoyunlaile.github.io/2020/microservice/opentracing/index.html">
<meta property="og:site_name" content="好运来了">
<meta property="og:description" content="概念当我们把系统微服务化后，想查询某个接口一次请求的耗时信息，需要登录多台机器查询相关日志才行。 如下图所示架构，当对应服务集群化部署后，想要查询到某一次请求信息更是难上加难。那我们有什么办法可以解决这个问题么？ 答案当然是有的，分布式追踪系统正是为了解决这个问题而生。分布式跟踪为描述和分析跨进程事务提供了一种解决方案。如Google Dapper论文 (业界的分布式追踪系统基本都是以这篇论文为基">
<meta property="og:image" content="http://haoyunlaile.github.io/images/microservice/micro-arch.jpg">
<meta property="og:image" content="http://haoyunlaile.github.io/images/microservice/tracing-mental-model.png">
<meta property="og:image" content="http://haoyunlaile.github.io/images/microservice/traces-jaeger-index.png">
<meta property="og:image" content="http://haoyunlaile.github.io/images/microservice/trace-detail-jaeger.png">
<meta property="og:image" content="http://haoyunlaile.github.io/images/microservice/trace-flow.png">
<meta property="og:image" content="http://haoyunlaile.github.io/images/microservice/tracing-extract.png">
<meta property="og:image" content="http://haoyunlaile.github.io/images/microservice/cncf-tracing.png">
<meta property="article:published_time" content="2020-05-07T11:00:00.000Z">
<meta property="article:modified_time" content="2020-05-07T11:00:00.000Z">
<meta property="article:author" content="好运来了">
<meta property="article:tag" content="分布式跟踪">
<meta property="article:tag" content="opentracing">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://haoyunlaile.github.io/images/microservice/micro-arch.jpg">

<link rel="canonical" href="http://haoyunlaile.github.io/2020/microservice/opentracing/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>分布式跟踪系统 | 好运来了</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?55ae289b7e76ebbe6ab20e60c74bad9d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="好运来了" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">好运来了</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">分享知识、记录点滴</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://haoyunlaile.github.io/2020/microservice/opentracing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="好运来了">
      <meta itemprop="description" content="java,go,istio,mosn,service mesh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="好运来了">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          分布式跟踪系统
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-07 19:00:00" itemprop="dateCreated datePublished" datetime="2020-05-07T19:00:00+08:00">2020-05-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>当我们把系统微服务化后，想查询某个接口一次请求的耗时信息，需要登录多台机器查询相关日志才行。 如下图所示架构，当对应服务集群化部署后，想要查询到某一次请求信息更是难上加难。那我们有什么办法可以解决这个问题么？</p>
<p>答案当然是有的，分布式追踪系统正是为了解决这个问题而生。分布式跟踪为描述和分析跨进程事务提供了一种解决方案。如<a href="https://research.google/pubs/pub36356/" target="_blank" rel="noopener">Google Dapper论文</a> (业界的分布式追踪系统基本都是以这篇论文为基础进行实现)所述，分布式跟踪的一些使用场景包括：</p>
<ol>
<li>异常检测，问题诊断</li>
<li>分布式系统内各组件的调用情况 </li>
<li>性能/延迟优化 </li>
<li>服务依赖性分析 </li>
</ol>
<p><img data-src="/images/microservice/micro-arch.jpg" alt="micro-arch"></p>
<a id="more"></a>

<p>因为业界分布式追踪系统众多，各家Api定义上有一定的差异，为了统一标准，于是OpenTracing出现了。</p>
<blockquote>
<p>什么是OpenTracing? </p>
<p>OpenTracing通过提供平台无关、厂商无关的API，使得开发人员能够方便的添加或更换追踪系统的实现。OpenTracing正在为全球的分布式追踪，提供统一的概念和数据标准。 </p>
<p>除了OpenTracing外，还有OpenCensus 这个项目，OpenCensus 由google发起，它除了包含tracing外，还包含度量（metrics）。</p>
<p>两套分布式追踪框架，都有很多追随者，都想统一对方，但最终结果是对峙不下，最后两个组织一起组队新建了OpenTelemetry项目。项目的第一宗旨就是：兼容OpenTracing和OpenSensus。对于使用OpenTracing或OpenSensus的应用不需要重新改动就可以接入OpenTelemetry。</p>
</blockquote>
<h3 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h3><p><img data-src="/images/microservice/tracing-mental-model.png" alt="tracing-mental-model"></p>
<p>从应用角度看分布式追踪系统所处的位置</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>先来看两张效果图感受一下（以jaeger ui为例）</p>
<p><img data-src="/images/microservice/traces-jaeger-index.png" alt="traces-jaeger-index"></p>
<p><img data-src="/images/microservice/trace-detail-jaeger.png" alt="trace-detail-jaeger"></p>
<h2 id="语义"><a href="#语义" class="headerlink" title="语义"></a>语义</h2><p>这里的语义以 OpenTracing 为基础。</p>
<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Span A]  ←←←(the root span)</span><br><span class="line">            |</span><br><span class="line">     +------+------+</span><br><span class="line">     |             |</span><br><span class="line"> [Span B]      [Span C] ←←←(Span C is a `ChildOf` Span A)</span><br><span class="line">     |             |</span><br><span class="line"> [Span D]      +---+-------+</span><br><span class="line">               |           |</span><br><span class="line">           [Span E]    [Span F] &gt;&gt;&gt; [Span G] &gt;&gt;&gt; [Span H]</span><br><span class="line">                                       ↑</span><br><span class="line">                                       ↑</span><br><span class="line">                                       ↑</span><br><span class="line">                         (Span G `FollowsFrom` Span F)</span><br></pre></td></tr></table></figure>

<h3 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h3><p>有些时候，使用下面这种基于时间轴的时序图可以更好的展现<strong>Trace</strong>（调用链） </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">––|–––––––|–––––––|–––––––|–––––––|–––––––|–––––––|–––––––|–&gt; time</span><br><span class="line"></span><br><span class="line"> [Span A···················································]</span><br><span class="line">   [Span B··············································]</span><br><span class="line">      [Span D··········································]</span><br><span class="line">    [Span C········································]</span><br><span class="line">         [Span E·······]        [Span F··] [Span G··] [Span H··]</span><br></pre></td></tr></table></figure>

<p><img data-src="/images/microservice/trace-flow.png" alt="trace-flow"></p>
<p>这种展现方式增加显示了执行时间的上下文，相关服务间的层次关系，进程或者任务的串行或并行调用关系。这样的视图有助于发现系统调用的关键路径。通过关注关键路径的执行过程，项目团队可专注于优化路径中的关键位置，最大幅度的提升系统性能。 </p>
<h3 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h3><p>一条<strong>Trace</strong>是指一个请求包含的调用链(包含下游所有请求的调用链)， 一条<strong>Trace</strong>可以被认为是一个由多个<strong>Span</strong>组成的有向无环图， <strong>Span</strong>与<strong>Span</strong>的关系被命名为<strong>References</strong>。</p>
<h3 id="Operation-Names"><a href="#Operation-Names" class="headerlink" title="Operation Names"></a>Operation Names</h3><p>每一个<strong>Span</strong>都有一个操作名称，这个名称简单，并具有可读性高。（例如：一个RPC方法的名称，一个函数名，或者一个大型计算过程中的子任务或阶段） </p>
<h3 id="Span"><a href="#Span" class="headerlink" title="Span"></a>Span</h3><p> 一个<strong>Span</strong>代表系统中具有开始时间和执行时长的逻辑运行单元 。具体可以理解为一次方法调用， 一个程序块的调用或者一次RPC/数据库访问。</p>
<p>每个<strong>Span</strong>包含以下的状态:</p>
<ul>
<li>An operation name，操作名称</li>
<li>A start timestamp，起始时间</li>
<li>A finish timestamp，结束时间</li>
<li><strong>Span Tags</strong>，一组键值对构成的Span标签集合。键值对中，键必须为string，值可以是字符串，布尔，或者数字类型。</li>
<li><strong>Span Logs</strong>，一组span的日志集合。 每次log操作包含一个键值对，以及一个时间戳。 键值对中，键必须为string，值可以是任意类型。 但是需要注意，不是所有的支持OpenTracing的Tracer,都需要支持所有的值类型。</li>
<li><strong>SpanContext</strong>，Span上下文对象 (下面会详细说明)</li>
<li><strong>References</strong>(Span间关系)，相关的零个或者多个Span（<strong>Span</strong>间通过<strong>SpanContext</strong>建立这种关系）</li>
</ul>
<p>每一个<strong>SpanContext</strong>包含以下状态：</p>
<ul>
<li>任何一个OpenTracing的实现，都需要将当前调用链的状态（例如： spanID 和traceID ），依赖一个独特的Span去跨进程边界传输</li>
<li><strong>Baggage Items</strong>，Trace的随行数据，是一个键值对集合，它存在于trace中，也需要跨进程边界传输</li>
</ul>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p> 一个<strong>Span</strong>可以和一个或者多个<strong>Span</strong>间存在因果关系。  OpenTracing定义了两种关系：<code>ChildOf</code> 和 <code>FollowsFrom</code>。<strong>这两种引用类型代表了子节点和父节点间的直接因果关系</strong>。 </p>
<h4 id="ChildOf-引用"><a href="#ChildOf-引用" class="headerlink" title="ChildOf 引用"></a><code>ChildOf</code> 引用</h4><p> 一个<strong>Span</strong>可能是一个父级<strong>Span</strong>的孩子，即<code>ChildOf</code> 关系。在<code>ChildOf</code> 引用关系下，父级span某种程度上取决于子<strong>Span</strong>。下面这些情况会构成<code>ChildOf</code> 关系：</p>
<ul>
<li><p>一个RPC调用的服务端的<strong>Span</strong>，和RPC服务客户端的<strong>Span</strong>构成<code>ChildOf</code> 关系</p>
</li>
<li><p>一个sql insert操作的<strong>Span</strong>，和ORM的save方法的<strong>Span</strong>构成<code>ChildOf</code> 关系</p>
</li>
<li><p>很多span可以并行工作（或者分布式工作）都可能是一个父级的<strong>Span</strong>的子项，他会合并所有子<strong>Span</strong>的执行结果，并在指定期限内返回</p>
<p>下面表述一个<code>ChildOf</code> 关系的父子节点关系的时序图:</p>
</li>
</ul>
<h4 id="FollowsFrom-引用"><a href="#FollowsFrom-引用" class="headerlink" title="FollowsFrom 引用"></a><strong><code>FollowsFrom</code> 引用</strong></h4><p>一些父级节点不以任何方式依然他们子节点的执行结果，这种情况下，我们说这些子<strong>Span</strong>和父<strong>Span</strong>之间是<code>FollowsFrom</code> 的因果关系。 </p>
<p> 下面表述一个<code>FollowsFrom</code> 关系的父子节点关系的时序图:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[-Parent Span-]  [-Child Span-]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    [-Parent Span--]</span><br><span class="line">     [-Child Span-]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    [-Parent Span-]</span><br><span class="line">                [-Child Span-]</span><br></pre></td></tr></table></figure>

<h3 id="Tags"><a href="#Tags" class="headerlink" title="Tags"></a>Tags</h3><p>每个<strong>Span</strong>可以有多个键值对（key:value）形式的<strong>Tags</strong>，<strong>Tags</strong>是没有时间戳的，支持简单的对<strong>Span</strong>进行注解和补充。  Span的tag不会跨进程传输，因此它们不会被子级的span继承。</p>
<p>必填参数</p>
<ul>
<li><p>tag key，必须是string类型</p>
</li>
<li><p>tag value，类型为字符串，布尔或者数字</p>
<p>注意，OpenTracing标准包含<strong><a href="https://opentracing.io/specification/conventions/" target="_blank" rel="noopener">“standard tags，标准Tag”</a></strong>，此文档中定义了Tag的标准含义。 </p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Tag名称</th>
<th>字段类型</th>
<th>字段解释及示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>component</code></td>
<td>string</td>
<td>The software package, framework, library, or module that generated the associated Span. E.g., <code>&quot;grpc&quot;</code>, <code>&quot;django&quot;</code>, <code>&quot;JDBI&quot;</code>.</td>
</tr>
<tr>
<td><code>db.instance</code></td>
<td>string</td>
<td>Database instance name. E.g., In java, if the jdbc.url=<code>&quot;jdbc:mysql://127.0.0.1:3306/customers&quot;</code>, the instance name is <code>&quot;customers&quot;</code>.</td>
</tr>
<tr>
<td><code>db.statement</code></td>
<td>string</td>
<td>A database statement for the given database type. E.g., for <code>db.type=&quot;sql&quot;</code>, <code>&quot;SELECT * FROM wuser_table&quot;</code>; for <code>db.type=&quot;redis&quot;</code>, <code>&quot;SET mykey &#39;WuValue&#39;&quot;</code>.</td>
</tr>
<tr>
<td><code>db.type</code></td>
<td>string</td>
<td>Database type. For any SQL database, <code>&quot;sql&quot;</code>. For others, the lower-case database category, e.g. <code>&quot;cassandra&quot;</code>, <code>&quot;hbase&quot;</code>, or <code>&quot;redis&quot;</code>.</td>
</tr>
<tr>
<td><code>db.user</code></td>
<td>string</td>
<td>Username for accessing database. E.g., <code>&quot;readonly_user&quot;</code> or <code>&quot;reporting_user&quot;</code></td>
</tr>
<tr>
<td><code>error</code></td>
<td>bool</td>
<td><code>true</code> if and only if the application considers the operation represented by the Span to have failed</td>
</tr>
<tr>
<td><code>http.method</code></td>
<td>string</td>
<td>HTTP method of the request for the associated Span. E.g., <code>&quot;GET&quot;</code>, <code>&quot;POST&quot;</code></td>
</tr>
<tr>
<td><code>http.status_code</code></td>
<td>integer</td>
<td>HTTP response status code for the associated Span. E.g., 200, 503, 404</td>
</tr>
<tr>
<td><code>http.url</code></td>
<td>string</td>
<td>URL of the request being handled in this segment of the trace, in standard URI format. E.g., <code>&quot;https://domain.net/path/to?resource=here&quot;</code></td>
</tr>
<tr>
<td><code>message_bus.destination</code></td>
<td>string</td>
<td>An address at which messages can be exchanged. E.g. A Kafka record has an associated <code>&quot;topic name&quot;</code> that can be extracted by the instrumented producer or consumer and stored using this tag.</td>
</tr>
<tr>
<td><code>peer.address</code></td>
<td>string</td>
<td>Remote “address”, suitable for use in a networking client library. This may be a <code>&quot;ip:port&quot;</code>, a bare <code>&quot;hostname&quot;</code>, a FQDN, or even a JDBC substring like <code>&quot;mysql://prod-db:3306&quot;</code></td>
</tr>
<tr>
<td><code>peer.hostname</code></td>
<td>string</td>
<td>Remote hostname. E.g., <code>&quot;opentracing.io&quot;</code>, <code>&quot;internal.dns.name&quot;</code></td>
</tr>
<tr>
<td><code>peer.ipv4</code></td>
<td>string</td>
<td>Remote IPv4 address as a <code>.</code>-separated tuple. E.g., <code>&quot;127.0.0.1&quot;</code></td>
</tr>
<tr>
<td><code>peer.ipv6</code></td>
<td>string</td>
<td>Remote IPv6 address as a string of colon-separated 4-char hex tuples. E.g., <code>&quot;2001:0db8:85a3:0000:0000:8a2e:0370:7334&quot;</code></td>
</tr>
<tr>
<td><code>peer.port</code></td>
<td>integer</td>
<td>Remote port. E.g., <code>80</code></td>
</tr>
<tr>
<td><code>peer.service</code></td>
<td>string</td>
<td>Remote service name (for some unspecified definition of <code>&quot;service&quot;</code>). E.g., <code>&quot;elasticsearch&quot;</code>, <code>&quot;a_custom_microservice&quot;</code>, <code>&quot;memcache&quot;</code></td>
</tr>
<tr>
<td><code>sampling.priority</code></td>
<td>integer</td>
<td>If greater than 0, a hint to the Tracer to do its best to capture the trace. If 0, a hint to the trace to not-capture the trace. If absent, the Tracer should use its default sampling mechanism.</td>
</tr>
<tr>
<td><code>span.kind</code></td>
<td>string</td>
<td>Either <code>&quot;client&quot;</code> or <code>&quot;server&quot;</code> for the appropriate roles in an RPC, and <code>&quot;producer&quot;</code> or <code>&quot;consumer&quot;</code> for the appropriate roles in a messaging scenario.</td>
</tr>
</tbody></table>
<h3 id="Logs"><a href="#Logs" class="headerlink" title="Logs"></a>Logs</h3><p>每个<strong>Span</strong>可以进行多次<strong>Logs</strong>操作，每一次<strong>Logs</strong>操作，都需要一个带时间戳的时间名称，以及可选的任意大小的存储结构。 </p>
<p>必填参数</p>
<ul>
<li>一个或者多个键值对，其中键必须是字符串类型，值可以是任意类型。某些OpenTracing实现，可能支持更多的log值类型。</li>
</ul>
<p>可选参数</p>
<ul>
<li><p>一个明确的时间戳。如果指定时间戳，那么它必须在span的开始和结束时间之内。</p>
<p>注意，OpenTracing标准包含<strong><a href="https://opentracing.io/specification/conventions/" target="_blank" rel="noopener">“standard log keys，标准log的键”</a></strong>，此文档中定义了这些键的标准含义。 </p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Log名称</th>
<th>字段类型</th>
<th>字段解释及示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>error.kind</code></td>
<td>string</td>
<td>The type or “kind” of an error (only for <code>event=&quot;error&quot;</code> logs). E.g., <code>&quot;Exception&quot;</code>, <code>&quot;OSError&quot;</code></td>
</tr>
<tr>
<td><code>error.object</code></td>
<td>object</td>
<td>For languages that support such a thing (e.g., Java, Python), the actual Throwable/Exception/Error object instance itself. E.g., A <code>java.lang.UnsupportedOperationException</code> instance, a python <code>exceptions.NameError</code> instance</td>
</tr>
<tr>
<td><code>event</code></td>
<td>string</td>
<td>A stable identifier for some notable moment in the lifetime of a Span. For instance, a mutex lock acquisition or release or the sorts of lifetime events in a browser page load described in the <a href="https://developer.mozilla.org/en-US/docs/Web/API/PerformanceTiming" target="_blank" rel="noopener">Performance.timing</a> specification. E.g., from Zipkin, <code>&quot;cs&quot;</code>, <code>&quot;sr&quot;</code>, <code>&quot;ss&quot;</code>, or <code>&quot;cr&quot;</code>. Or, more generally, <code>&quot;initialized&quot;</code> or <code>&quot;timed out&quot;</code>. For errors, <code>&quot;error&quot;</code></td>
</tr>
<tr>
<td><code>message</code></td>
<td>string</td>
<td>A concise, human-readable, one-line message explaining the event. E.g., <code>&quot;Could not connect to backend&quot;</code>, <code>&quot;Cache invalidation succeeded&quot;</code></td>
</tr>
<tr>
<td><code>stack</code></td>
<td>string</td>
<td>A stack trace in platform-conventional format; may or may not pertain to an error. E.g., <code>&quot;File \&quot;example.py\&quot;, line 7, in \\ncaller()\nFile \&quot;example.py\&quot;, line 5, in caller\ncallee()\nFile \&quot;example.py\&quot;, line 2, in callee\nraise Exception(\&quot;Yikes\&quot;)\n&quot;</code></td>
</tr>
</tbody></table>
<h3 id="SpanContext"><a href="#SpanContext" class="headerlink" title="SpanContext"></a>SpanContext</h3><p> <strong>SpanContext</strong>更多的是一个“概念” 。每个<strong>Span</strong>都必须提供方法访问<strong>SpanContext</strong>。SpanContext代表跨越进程边界，传递到下级<strong>Span</strong>的状态，并用于封装<strong>Baggage</strong> 。 OpenTracing的使用者仅仅需要，在创建<strong>Span</strong>、向传输协议Inject（注入）和从传输协议中Extract（提取）时使用 。</p>
<h3 id="Baggage"><a href="#Baggage" class="headerlink" title="Baggage"></a>Baggage</h3><p>Baggage元素是一个键值对集合，将这些值设置给给定的<code>Span</code>，<code>Span</code>的<code>SpanContext</code>，以及<strong>所有和此<code>Span</code>有直接或者间接关系的本地<code>Span</code>。</strong> 也就是说，baggage元素随<strong>Trace</strong>一起应用程序调用过程 一同传播  </p>
<p>Baggage拥有强大功能，也会有很大的<em>消耗</em>。由于Baggage的全局传输，如果包含的数量量太大，或者元素太多，它将降低系统的吞吐量或增加RPC的延迟。 </p>
<h3 id="Inject-and-Extract"><a href="#Inject-and-Extract" class="headerlink" title="Inject and Extract"></a>Inject and Extract</h3><p><code>SpanContext</code>可以通过<strong>Injected</strong>操作向<strong>Carrier</strong>增加，或者通过<strong>Extracted</strong>从<strong>Carrier</strong>中获取，跨进程通讯数据。通过这种方式，SpanContexts可以跨越进程边界，并提供足够的信息来建立跨进程的span间关系（因此可以实现跨进程连续追踪）。 </p>
<p>Inject 类比传递序列化后的参数</p>
<p>Extract 反序列化Inject的参数值</p>
<p>传递方式例如：</p>
<ol>
<li>依赖HTTP头传递（B3-header）</li>
<li>Dubbo 定制<strong>Filter</strong>通过 <strong><em>RpcContext</em></strong> 设置 <strong>Attachment</strong> 来传递</li>
</ol>
<p><strong>Carrier</strong>可以是一个接口或者一个数据载体，他对于跨进程通讯是十分有帮助的。<strong>Carrier</strong>负责将追踪状态从一个进程”carries”传递到另一个进程 。OpenTracing规定所有平台的实现者支持两种Carrier格式：基于”text map”（基于字符串的map）的格式和基于”binary”（二进制）的格式。</p>
<ul>
<li><em>text map</em> 格式的 Carrier是一个平台惯用的map格式，基于unicode编码的<code>字符串</code>对<code>字符串</code>键值对</li>
<li><em>binary</em> 格式的 Carrier 是一个不透明的二进制数组（更紧凑和有效）</li>
</ul>
<p><img data-src="/images/microservice/tracing-extract.png" alt="tracing-extract"></p>
<h2 id="开源"><a href="#开源" class="headerlink" title="开源"></a>开源</h2><h3 id="语言支持"><a href="#语言支持" class="headerlink" title="语言支持"></a>语言支持</h3><ul>
<li><a href="https://github.com/opentracing/opentracing-go" target="_blank" rel="noopener">Go</a></li>
<li><a href="https://github.com/opentracing/opentracing-javascript" target="_blank" rel="noopener">JavaScript</a></li>
<li><a href="https://github.com/opentracing/opentracing-java" target="_blank" rel="noopener">Java</a></li>
<li><a href="https://github.com/opentracing/opentracing-python" target="_blank" rel="noopener">Python</a></li>
<li><a href="https://github.com/opentracing/opentracing-ruby" target="_blank" rel="noopener">Ruby</a></li>
<li><a href="https://github.com/opentracing/opentracing-php" target="_blank" rel="noopener">PHP</a></li>
<li><a href="https://github.com/opentracing/opentracing-objc" target="_blank" rel="noopener">Objective-C</a></li>
<li><a href="https://github.com/opentracing/opentracing-cpp" target="_blank" rel="noopener">C++</a></li>
<li><a href="https://github.com/opentracing/opentracing-csharp" target="_blank" rel="noopener">C#</a></li>
</ul>
<h3 id="框架支持"><a href="#框架支持" class="headerlink" title="框架支持"></a>框架支持</h3><ul>
<li><a href="https://opentracing.io/docs/supported-tracers/#cncf-jaeger" target="_blank" rel="noopener">CNCF Jaeger</a></li>
<li><a href="https://opentracing.io/docs/supported-tracers/#lightstep" target="_blank" rel="noopener">LightStep</a></li>
<li><a href="https://opentracing.io/docs/supported-tracers/#instana" target="_blank" rel="noopener">Instana</a></li>
<li><a href="https://opentracing.io/docs/supported-tracers/#apache-skywalking" target="_blank" rel="noopener">Apache SkyWalking</a></li>
<li><a href="https://opentracing.io/docs/supported-tracers/#inspectit" target="_blank" rel="noopener">inspectIT</a></li>
<li><a href="https://opentracing.io/docs/supported-tracers/#stagemonitor" target="_blank" rel="noopener">stagemonitor</a></li>
<li><a href="https://opentracing.io/docs/supported-tracers/#datadog" target="_blank" rel="noopener">Datadog</a></li>
<li><a href="https://opentracing.io/docs/supported-tracers/#wavefront-by-vmware" target="_blank" rel="noopener">Wavefront by VMware</a></li>
<li><a href="https://opentracing.io/docs/supported-tracers/#elastic-apm" target="_blank" rel="noopener">Elastic APM</a></li>
</ul>
<p>通过cncf社区链接也可以查询到相关框架</p>
<p> <a href="https://landscape.cncf.io/category=tracing&amp;format=card-mode&amp;grouping=category" target="_blank" rel="noopener">https://landscape.cncf.io/category=tracing&amp;format=card-mode&amp;grouping=category</a> </p>
<p><img data-src="/images/microservice/cncf-tracing.png" alt="cncf-tracing"></p>
<h3 id="框架选型"><a href="#框架选型" class="headerlink" title="框架选型"></a>框架选型</h3><p>如果公司用的Java体系可以选择 Zipkin 或者 SkyWalking 。Zipkin 主要是tracing，而SkyWalking整体是APM，包含tracing。如果不打算做二次开发建议选SkyWalking，开箱即用（目前存储主要支持ElasticSearch）。</p>
<p>目前云原生体系在大力推Jaeger (Go语言研发)，如果公司有go体系，也是个不错的选择。</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p> <a href="https://opentracing.io/" target="_blank" rel="noopener">https://opentracing.io/</a> </p>
<p> <a href="https://github.com/opentracing/specification" target="_blank" rel="noopener">https://github.com/opentracing/specification</a> </p>
<p> <a href="https://github.com/opentracing-contrib" target="_blank" rel="noopener">https://github.com/opentracing-contrib</a></p>
<p> <a href="https://wu-sheng.gitbooks.io/opentracing-io/content/" target="_blank" rel="noopener">https://wu-sheng.gitbooks.io/opentracing-io/content/</a> </p>
<p> <a href="https://opencensus.io/" target="_blank" rel="noopener">https://opencensus.io/</a> </p>
<p> <a href="https://opentelemetry.io/" target="_blank" rel="noopener">https://opentelemetry.io/</a> </p>

    </div>

    
    
    
        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

            <div class="social-item">
              <a target="_blank" class="social-link" href="/atom.xml">
                <span class="icon">
                  <i class="fa fa-rss"></i>
                </span>

                <span class="label">RSS</span>
              </a>
            </div>
    </div>
  </div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E8%B7%9F%E8%B8%AA/" rel="tag"><i class="fa fa-tag"></i> 分布式跟踪</a>
              <a href="/tags/opentracing/" rel="tag"><i class="fa fa-tag"></i> opentracing</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/microservice/tarde-middle-platform/" rel="prev" title="交易中台技术栈全景">
      <i class="fa fa-chevron-left"></i> 交易中台技术栈全景
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/microservice/jaeger-tracing/" rel="next" title="jaeger tracing">
      jaeger tracing <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#概念"><span class="nav-number">1.</span> <span class="nav-text">概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#模型"><span class="nav-number">1.1.</span> <span class="nav-text">模型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#示例"><span class="nav-number">2.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#语义"><span class="nav-number">3.</span> <span class="nav-text">语义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据模型"><span class="nav-number">3.1.</span> <span class="nav-text">数据模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#时序图"><span class="nav-number">3.2.</span> <span class="nav-text">时序图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Trace"><span class="nav-number">3.3.</span> <span class="nav-text">Trace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Operation-Names"><span class="nav-number">3.4.</span> <span class="nav-text">Operation Names</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Span"><span class="nav-number">3.5.</span> <span class="nav-text">Span</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#References"><span class="nav-number">3.6.</span> <span class="nav-text">References</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ChildOf-引用"><span class="nav-number">3.6.1.</span> <span class="nav-text">ChildOf 引用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FollowsFrom-引用"><span class="nav-number">3.6.2.</span> <span class="nav-text">FollowsFrom 引用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tags"><span class="nav-number">3.7.</span> <span class="nav-text">Tags</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Logs"><span class="nav-number">3.8.</span> <span class="nav-text">Logs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SpanContext"><span class="nav-number">3.9.</span> <span class="nav-text">SpanContext</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Baggage"><span class="nav-number">3.10.</span> <span class="nav-text">Baggage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Inject-and-Extract"><span class="nav-number">3.11.</span> <span class="nav-text">Inject and Extract</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开源"><span class="nav-number">4.</span> <span class="nav-text">开源</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#语言支持"><span class="nav-number">4.1.</span> <span class="nav-text">语言支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#框架支持"><span class="nav-number">4.2.</span> <span class="nav-text">框架支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#框架选型"><span class="nav-number">4.3.</span> <span class="nav-text">框架选型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文献"><span class="nav-number">5.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="好运来了"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">好运来了</p>
  <div class="site-description" itemprop="description">java,go,istio,mosn,service mesh</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
        
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/haoyunlaile" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;haoyunlaile" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">好运来了</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-ribbon@1/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>


  <script defer src="//cdn.jsdelivr.net/gh/theme-next/theme-next-three@1/three.min.js"></script>
    <script defer src="//cdn.jsdelivr.net/gh/theme-next/theme-next-three@1/three-waves.min.js"></script>


  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>















  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'eae8063453ebca094cce',
      clientSecret: 'b044d5891d0dbc7ae2c891936b31998785caf71a',
      repo        : 'haoyunlaile.github.io',
      owner       : 'haoyunlaile',
      admin       : ['haoyunlaile'],
      id          : 'a92baf56393762f2cb24079db07f21c8',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
